#include <linux/linkage.h>
#include <asm/ibt.h>

.text
.align 16
SYM_FUNC_START(aes_gcm_encrypt)
    # AES(J1) -> X0
    movdqu j1(%rip), %xmm0; pxor key0(%rip), %xmm0
    .irp K,1,2,3,4,5,6,7,8,9
      aesenc key\K(%rip), %xmm0
    .endr; aesenclast key10(%rip), %xmm0

    # C = P ^ X0
    movdqu (%rsi), %xmm1; pxor %xmm0, %xmm1; movdqa %xmm1, %xmm10

    # H = AES(0)
    movdqu zero(%rip), %xmm2; pxor key0(%rip), %xmm2
    .irp K,1,2,3,4,5,6,7,8,9
      aesenc key\K(%rip), %xmm2
    .endr; aesenclast key10(%rip), %xmm2

    # Y0 = AES(J0)
    movdqu j0(%rip), %xmm3; pxor key0(%rip), %xmm3
    .irp K,1,2,3,4,5,6,7,8,9
      aesenc key\K(%rip), %xmm3
    .endr; aesenclast key10(%rip), %xmm3

    # GHASH(H,C)->X2
    movdqa %xmm2, %xmm0; movdqa %xmm10, %xmm1
    pclmulqdq $0x00, %xmm1, %xmm5; pclmulqdq $0x11, %xmm1, %xmm6
    pclmulqdq $0x10, %xmm1, %xmm7; pclmulqdq $0x01, %xmm1, %xmm8
    # reduction
    pslld $1, %xmm5; pslld $1, %xmm6
    psrld $31, %xmm7; psrld $31, %xmm8
    pslldq $4, %xmm8; pslldq $4, %xmm7
    psrldq $12, %xmm7; por %xmm7, %xmm5
    por %xmm8, %xmm6; por %xmm5, %xmm6
    movdqa %xmm6, %xmm0

    # GHASH(H,X^L)->X1
    movdqu len(%rip), %xmm2; pxor %xmm0, %xmm2
    movdqa %xmm2, %xmm1; movdqa %xmm0, %xmm5
    pclmulqdq $0x00, %xmm1, %xmm5; pclmulqdq $0x11, %xmm1, %xmm6
    pclmulqdq $0x10, %xmm1, %xmm7; pclmulqdq $0x01, %xmm1, %xmm8
    # reduction
    pslld $1, %xmm5; pslld $1, %xmm6
    psrld $31, %xmm7; psrld $31, %xmm8
    pslldq $4, %xmm8; pslldq $4, %xmm7
    psrldq $12, %xmm7; por %xmm7, %xmm5
    por %xmm8, %xmm6; por %xmm5, %xmm6
    movdqa %xmm6, %xmm2

    # Tag = Y0 ^ X1
    pxor %xmm2, %xmm3

    # Store C|T
    movdqu %xmm10, (%rdi); movdqu %xmm3, 16(%rdi)
    RET
SYM_FUNC_END(aes_gcm_encrypt)

.data
.align 16
key0:   .byte 0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c
key1:   .byte 0xa0,0xfa,0xfe,0x17,0x88,0x54,0x2c,0xb1,0x23,0xa3,0x39,0x39,0x2a,0x6c,0x76,0x05
key2:   .byte 0xf2,0xc2,0x95,0xf2,0x7a,0x96,0xb9,0x43,0x59,0x35,0x80,0x7a,0x73,0x26,0x46,0xfe
key3:   .byte 0x3b,0x6a,0x27,0x94,0x88,0x20,0x2f,0xf0,0x0d,0x1a,0xf2,0xfe,0x79,0xe0,0x14,0x9a
key4:   .byte 0xec,0x92,0xa9,0x2f,0xef,0x3c,0x7f,0x9f,0x2d,0x9f,0xe1,0x7a,0x33,0x8f,0x1b,0x3d
key5:   .byte 0x86,0x31,0x3a,0x6a,0x6f,0x16,0x1a,0xed,0x33,0x8a,0x01,0xa9,0x90,0x12,0x45,0xbc
key6:   .byte 0xc6,0x4f,0xd9,0x7e,0x5c,0x05,0xa5,0x9b,0x31,0xf4,0xad,0xbe,0xb2,0x5a,0x1a,0xa9
key7:   .byte 0xc2,0x99,0x06,0xed,0x82,0xff,0xf8,0xa0,0x98,0x10,0x44,0xcc,0x38,0x2e,0xd3,0x0a
key8:   .byte 0x73,0xff,0x61,0xea,0xf1,0x00,0x99,0x4a,0x69,0x10,0xdd,0x86,0x51,0x3e,0x0e,0x8c
key9:   .byte 0xda,0x54,0x05,0x3b,0x2b,0x54,0x9c,0x71,0x42,0x44,0x41,0xf7,0x13,0x7a,0x4f,0x7b
key10:  .byte 0x36,0xd0,0x24,0x46,0x1d,0x84,0xb8,0x37,0x5f,0xc0,0xf9,0xc0,0x4c,0xba,0xb6,0xbb
.align 16
j0:     .byte 0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1a,0x1b,0x00,0x00,0x00,0x01
.align 16
j1:     .byte 0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1a,0x1b,0x00,0x00,0x00,0x02
.align 16
zero:   .byte 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.align 16
len:    .byte 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80

